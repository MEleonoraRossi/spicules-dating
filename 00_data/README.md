# Data

In this directory, you will find the input data that we have used in our study.

## Alignment files

Directory [`aln`](aln) contains both individual alignments for each partition as inferred by `ModelFinder` as well as an alignment file with all these 5 partitions concatenated as "alignment blocks":

* [`part`](aln/part): `ModelFinder` was used to infer the best-fitting amino acid evolutionary model/s for our molecular alignment which, according to the results obtained, we partitioned into five alignment blocks: (i) [`JTT+G4+F`, 68 taxa and 25,620 bp](aln/part/JTTG4F.phy); (ii) [`JTT+G4+I`, 68 taxa and 11,212 bp](aln/part/JTTG4I.phy); (iii) [`JTT+Mut`, 66 taxa and 7,388 bp](aln/part/JTTMut.phy); (iv) [`LG+F`, 69 taxa and 9,947 bp](aln/part/LGF.phy); and (v) [`LG+I`, 70 taxa and 49,102 bp](aln/part/LGI.phy).
* [`conc`](aln/conc): partitioned alignment with the five alignment blocks listed in the order aforementioned.

## Tree files

### Raw phylogeny

We ran `PhyloBayes` under a CAT Poisson model for Bayesian phylogeny inference for over 7,000 generations until reaching a discrepancy of  across all bipartitions.

According to the developers of this software, "the discrepancy $d$ is defined as $d=\frac{2 \lvert \mu_{1}−\mu_{2} \rvert}{\sigma_{1}+\sigma_{σ}}$, where $\mu_{i}$ is the mean and $\sigma_{i}$ the standard deviation associated with a particular column and $i$ runs over the chains". We ran two chains and obtained a discrepancy of $\text{maxdiff}=0.002$. The developers consider a $\text{maxdiff}<0.1$ a good run, and thus we considered these two chains to have reached convergence.

The output of this run is summarised in the [`PhyloBayes_out.nexus`](tree/raw/PhyloBayes_out.nexus) NEXUS file. The inferred tree topology is the one we fixed in all the subsequent timetree inference analyses.

### Data formatting

The calibrated input tree needs to be in PHYLIP format. We first used [our R script `root_tree.R`](scripts/root_tree.R) to root the tree inferred by PhyloBayes after specifying our 6 taxa that are part of the outgroup: `Bolinopsis_ashleyi_pep_cdhit_B`, `Nematostella_vectensis_cdhit_N`, `Pleurobrachia_bachei_pep_cdhit`, `Lottia_gigantea_pep_cdhit_LGIG`, `Homo_sapiens_pep_cdhit_HSAP`, and `Aurelia_aurita_pep_cdhit_AAUR`. If you run the R script, you will generate file called `tree_root_bl_R.tree` inside a newly created directory [`scripts/reproduce`](tree/raw/scripts). You can verify by using scripting tools such as `diff` that this output is the same as the one we obtained: [`tree_root_bl_R.tree`](tree/raw/tree_root_bl_R.tree).

Sometimes, the branch lengths that lead to the two clades that diverge from the root tend to be badly inferred if separated, although no problems occur with their sum (i.e., unrooted trees). Therefore, we verified the rooting inferred using the `ape::root` option by manually rooting the tree using a graphical viewer (`FigTree`). If you want to reproduce what we did, make sure to rename file `tree_unroot_bl_tmp`, `tree_root_bl_R_v2`, and `tree_root_bl_FigTree.tree` as the following commands will overwrite them.

First, we got rid of labels and branch lengths in the nexus file generated by `PhyloBayes`:

```sh
# You should still be inside `tree/raw`
# If not, please move to this directory and run the
# following commands
tname=`ls *nexus`
t_noext=$( echo $tname | sed 's/\.nexus//' )
# Get tree only with branch lengths
# Extract the line that has the tree in Newick format
# from the NEXUS tree, remove characters before the tree
grep 'tree ' $tname | sed 's/..*\[\&R\]\ //' | sed 's/\[\&label\=1]//g' | sed 's/\[\&label\=0.99]//g' > tree_unroot_bl_tmp.tree
```

Then, we manually rooted the tree in `FigTree` and saved it as [`tree_root_bl_FigTree.tree`](tree/raw/tree_root_bl_FigTree.tree). As expected, the rooted tree in R has one branch length of length 0 and another of length 0.209979 $\approx$ 0.21. The tree manually rooted with `FigTree` has two branch lengths of equal length: 0.105. This scenario may sometimes occur when the tree is being rooted. While the sum of the two branch lengths that lead to the root is properly estimated (i.e., bl [unrooted tree with two clades] = bl1 [from clade 1 to root] + bl2 [from clade 2 to root]), the length of the the two branch lengths is difficult to estimate, and different heuristic approaches may lead to different estimated branch lengths (for a detailed explanation of this rooting issue, please see the [supplementary material provided by Álvarez-Carretero et al. 2023](http://abacus.gene.ucl.ac.uk/ziheng/pdf/2023Alvarez-Carretero-codeml-SI.pdf), especially Figure S1). In that way, instead of favouring a rooting in which one branch is 0 and another is 0.21, we decided to support the rooting in which such sum of branch lengths is divided into the two branch lengths leading to the root. We just kept the tree topology inferred by R as the clades are re-arranged in a more suitable order to interpret the analyses but we altered the two branch lengths that lead to the root to be $bl_{1}=bl_{2}=0.105$, resulting in the phylogeny that we later used to estimate the evolutionary rate. We manually edited [`tree_root_bl_R.tree`](tree/raw/tree_root_bl_R.tree) and generated a copy called [`tree_root_bl_R_v2.tree`](tree/raw/tree_root_bl_R_v2.tree) with such branch lengths.

### Tree calibration

Once we finished formatting the files, we ran our R script [`Include_calibrations.R`](tree/calib/add_calibs/Include_calibrations.R) to generate the calibrated tree files, which we have saved in the `calib` directory. Note that this script requires some input files that we have already prepared based on the topology defined in [`tree_root_bl_R_v2.tree`](tree/raw/tree_root_bl_R_v2.tree) to save some time:

* **Tree topology with labels**: the [`Pori_Cauchy_SM_NoSpi_573_label.tree` file](tree/calib/add_calibs/Pori_Cauchy_SM_NoSpi_573_label.tree) and the [`Pori_Cauchy_SM_SpiPori_573_label.tree` file](tree/calib/add_calibs/Pori_Cauchy_SM_SpiPori_573_label.tree) contain the two calibrated topologies we will be evaluating depending on whether the ages of nodes Porifera or Heterocleromorpha are constrained. Note that we also completed the tag IDs with their full name so that they match the corresponding tags used in the sequence file (i.e., [Matrix.phy](aln/conc/Matrix.phy)) -- we truncated the tag IDs during Bayesian phylogeny inference with `PhyloBayes` due to a restriction on their length when using this program. The 12 nodes which ages are being constrained by fossil calibrations have been manually flagged with labels in the format of `[CALIBRATION]`, where `CALIBRATION` can be replaced with the name of the node being calibrated (e.g., root, Eumetazoa, etc.). These labels are replaced with the corresponding calibrations in `MCMCtree` format by the R script (see below). It is important to note that the labels need to be written within square brackets and that the last line of this file is a blank line!
* **Matching files**: the [`Calib_converter_SpiPori.txt`](tree/calib/add_calibs/Calib_converter_SpiPori.txt) and [`Calib_converter_NoSpi.txt`](tree/calib/add_calibs/Calib_converter_NoSpi.txt) files include the name of the labels used to flag the nodes to be calibrated in the tree topologies above (e.g., `ROOT`, `EUMETAZOA`, etc.), followed by a pipe delimiter `|`, and then the calibration in `MCMCtree` format within single quotation marks (e.g., `L(min_age,c,p,pL)` for lower-bound calibrations or `B(min_age,max_age,pL,pU)` for soft-bound calibrations, the two types of calibrations we are using to constrain 12 node ages in our phylogeny). The R script will use these files to replace the labels in the corresponding tree topology with the matching calibrations. It is important that the last line of these files is a blank line!

If you run the R script [`Include_calibrations.R`](scripts/Include_calibrations.R), you will generate the two calibrated files we used as input files inside a newly created directory [`reproduce`](tree/calib/add_calibs/reproduce). You can then verify that you generate the same files we used in our analyses: [`Pori_Cauchy_SM_NoSpi_573.tree`](tree/calib/Pori_Cauchy_SM_NoSpi_573.tre) (i.e., age is constrained for clade Heterocleromopha) and [`Pori_Cauchy_SM_SpiPori_573_label.tree`](tree/calib/Pori_Cauchy_SM_NoSpi_573.tre) (i.e., age is constrained for clade Porifera).

## Uncalibrated files

Lastly, we will create a tree file without branch lengths, which we will subsequently use to run `CODEML` to calculate the branch lengths, the Hessian, and the gradient to approximate the likelihood calculation. You can generate the tree file we have inside directory [`uncalib`](tree/uncalib/tree_uncalib.tree) by running this command:

```sh
# Run from `tree/calib`
# Create a tree file in PHYLIP format by 
# getting the number of taxa from the NEXUS tree
# Tree topology is the same between the two files 
# as only calibrations differ
sed 's/\[[A-Z]*\]//g' ../Pori_Cauchy_SM_NoSpi_573.tree > tree_uncalib.tree
```
