# Bayesian inference of species divergences

Once we had the [`in.BV` file](../01_MCMCtree/inBV/in.BV) generated with `CODEML` (more details [in the `README.md` file in the `00_CODEML` directory](../00_CODEML/README.md)), we had everything we needed to run `MCMCtree`: the input [alignment file](../../00_data/aln/conc/Matrix.phy), the [calibrated tree file with the age of the porifera node constrained](../../00_data/tree/calib/Pori_Cauchy_SM_SpiPori_573.tre), the [calibrated tree file with the age of the heteroscleromorpha node constrained](../../00_data/tree/calib/Pori_Cauchy_SM_NoSpi_573.tre), and [the control files for each analysis](control_files).

Below, you will find a summary of the options we have enabled, the values we have specified to run each type of analysis, and justifications for the evolutionary models we chose according to the analyses we will subsequently describe:

* Random seed number (`seed`): by setting this option to `-1`, a random seed number will be generated for an analysis based on the time stamp.
* Path to the sequence file (`seqfile`): this option specified the path to the alignment file. You can see that either a soft link or the actual sequence file where in the same directory as the control files, and thus no relative paths are used.
* Path to the calibrated tree file (`seqfile`): this option specified the path to the calibrated file. You can see that either a soft link or the actual sequence file where in the same directory as the control files, and thus no relative paths are used.
* Path to the output file (`outfile`): this option specified the path to the alignment file. The output file is to be saved in the same directory where this control file is, and thus no relative paths are to be found.
* Number of partitions (`ndata`): the partitioned input file ([`Matrix.phy`](../../00_data/aln/conc/Matrix.phy)) has five alignment blocks, and thus this option is set to `5`.
* Sequence type (`seqtype`): the alignment file has amino acid sequences, and thus this option is set to `2`.
* Type of method to calculate the likelihood (`usedata`): this option is set to `0` when sampling from the prior (i.e., the alignment will not be used, and thus the likelihood will equal to 1) and to `2` when sampling from the posterior and using the approximate likelihood calculation (i.e., the `in.BV` file is always required when enabling this option, which we soft-link to the directory where the analysis is taking place for each dataset and model). If no specific absolute or relative path to the `in.BV` file is specified when `usedata = 2`, this file is expected to be saved in the same directory where the control file is saved (i.e., we create a soft link to our `in.BV` file to avoid duplicates).
* Type of clock model (`clock`): when the clock model does not matter because the data are not used (i.e., when sampling from the prior), this option is set to `1`. When sampling from the posterior, we have run two different types of analyses: (i) under the autocorrelated-rates model (AR, `clock = 3`, ([Thorne et al. 1998](https://pubmed.ncbi.nlm.nih.gov/9866200/), [Yang and Rannala 2006](https://pubmed.ncbi.nlm.nih.gov/16177230/))) and (ii) under the independent-rates model (IR, `clock = 2`, ([Rannala and Yang 2007](10.1080/10635150701420643), [Lemey et al. 2010](https://pubmed.ncbi.nlm.nih.gov/20203288/))).
* Dealing with ambiguity data (`cleandata`): we set this option to `0` as we did not remove site with ambiguity data. All sequence filtering and processing took care before timetree inference analyses as recommended.
* Birth-death process with species sampling prior (`BDparas`): this is the "tree prior", which is based on the birth-death process with species sampling of Yang and Rannala [1997](https://pubmed.ncbi.nlm.nih.gov/9214744/). We chose the values for the per-lineage birth rate ($\lambda$) and per-lineage death rate ($\mu$) of the model to be equal to 1, while the sampling fraction was $\rho=0.1$. These parameters yield a uniform kernel density that has an approximate uniform distribution (i.e., we assume that all possible tree shapes have the same probability). As per the PAML documentation, this kernel density is also informed by the nodes which ages have been constrained, and thus will specify the distribution of the ages of the nodes that have not been calibrated. This kernel density will therefore have an impact on the joint distribution of all node ages, which is the main reason for running the software without data first (i.e., `usedata = 0`). To this end, we can verify the prior distributions for both the calibrated and non-calibrated nodes while verifying our calibration densities (i.e., the "user-specified" priors we used to constrain some of the node ages) versus the marginal densities (i.e., the "effective prior", the prior distribution generated with the samples collected when sampling from the prior). Any major discrepancies may be due to truncation effects, and so users need to modify their input calibration densities to minimise their impact on the posterior time estimates. For more information on the matter, please read [dos Reis et al. (2015)](https://pubmed.ncbi.nlm.nih.gov/26603774/).
* Rate prior (`rgene_gamma`): we assumed an approximate evolutionary rate of 0.1 subst/site/100Myr (mean rate =~ 1e-09 substitutions per site per year). As our assumption is quite vague, we used a diffuse gamma prior with $\alpha=2$ and $\beta=20$ (i.e., $\text{mean rate}=\frac{\alpha}{\beta}=\frac{2}{20}=0.1$)
* Prior on the variation of the rate (`sigma2_gamma`): given that out phylogeny has very deep divergences, the clock may have been seriously violated, and thus we have fixed a mean for the `sigma2` parameter (i.e., variation in the clock) as 0.1 using a gamma prior with $\alpha=1$ and $\beta=10$ (i.e., $\text{mean sigma2}=\frac{\alpha}{\beta}=\frac{1}{10}=0.1$).
* MCMC burn-in (`burnin`): we chose to discard the samples collected during the first **100,000** iterations as burn-in.
* Sampling frequency during the MCMC (`sampfreq`): we chose to keep the samples collected for each model parameter every **100** iterations.
* Number of samples to be collected during the MCMC (`nsample`): we chose to collect a total of **20,000** samples. Following the MCMC settings we specified for both the AR and the IR relaxed-clock models, we ran a total of $100000+100\times 20000=2100000$ iterations (burnin + sampling_frequency*num_samples).
* Type of data that will be written out (`print`): we specified value `1` so that the samples collected for all model parameters are written out in file `mcmc.txt`.

>> **NOTE 1**: Note that two of the 6 chains we ran under the IR relaxed-clock model for the "NoSpi" model had different settings than those we used for the rest of our analyses: `burnin = 20000`, `sampfreq = 20`, and `nsample = 200000`. These settings were not optimal and, as later verified during our MCMC diagnostics, these two chains had to be discarded as the samples collected did not seem to have been collected from the target distribution we aimed to sample from.
>> **NOTE 2**: While we included the `finetune` option in the control file, please note that this option is deprecated as `MCMCtree` has an algorithm for finetuning now. If you run the control file with this option enabled, you will see that the output log file (i.e., files which name follows a format such as `slurm-[0-9]*.out` and are saved inside each corresponding directory in the compressed file you can download) will have a line that reads `finetune is deprecated now.`.

To make sure that we collected enough samples to guarantee a high enough effective sample size and ensure chain convergence, we ran 6 chains for each analysis:

* [**Prior - CLK+SpiPor**](control_files/pri_SpiPor_CLK.ctl): `usedata = 0`, `clock = 0`, `treefile = Pori_Cauchy_SM_SpiPori_573.tre`.
* [**Prior - CLK+NoSpi**](control_files/pri_SpiPor_CLK.ctl): `usedata = 0`, `clock = 0`, `treefile = Pori_Cauchy_SM_NoSpi_573.tre`.
* [**Posterior - AR+SpiPor**](control_files/post_SpiPor_AR.ctl): `usedata = 2`, `clock = 3`, `treefile = Pori_Cauchy_SM_SpiPori_573.tre`.
* [**Posterior - AR+NoSpi**](control_files/post_NoSpi_AR.ctl): `usedata = 2`, `clock = 3`, `treefile = Pori_Cauchy_SM_NoSpi_573.tre`.
* [**Posterior - IR+SpiPor**](control_files/post_SpiPor_IR.ctl): `usedata = 2`, `clock = 2`, `treefile = Pori_Cauchy_SM_SpiPori_573.tre`.
* [**Posterior - IR+NoSpi**](control_files/post_NoSpi_IR.ctl): `usedata = 2`, `clock = 2`, `treefile = Pori_Cauchy_SM_NoSpi_573.tre`.

Please note that our manuscript is currently under review, and so we will include a link to download all the output files obtained when running `MCMCtree` at the end of this process. Nevertheless, we have included all the scripts we used and the output files we generated during the MCMC diagnostics, and so you can reproduce our workflow and run your own `MCMCtree` analyses without requiring our output files! Please take a look at the [`02_MCMC_diagnostics`](../../02_MCMC_diagnostics/) directory for more details on the file structure we used (in case you also want to follow that!) and the filters we applied during MCMC diagnostics!
